<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Diabetes Readmission Indicators</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 24px; }
    .container { max-width: 980px; }
    .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
    @media (max-width: 900px){ .grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-3">Diabetes Readmission Prediction</h1>

    <form action="{{ url_for('predict_datapoint') }}" method="post" id="predictForm" novalidate>
      <div class="grid">
        <!-- 1) race -->
        <div class="mb-3">
          <label class="form-label">Race / Ethnicity</label>
          <select class="form-control" name="race" required>
            <option selected disabled value="">Select Race</option>
            <option value="Caucasian">Caucasian</option>
            <option value="AfricanAmerican">AfricanAmerican</option>
            <option value="Hispanic">Hispanic</option>
            <option value="Other">Other</option>
            <option value="Asian">Asian</option>
          </select>
        </div>

        <!-- 2) gender -->
        <div class="mb-3">
          <label class="form-label">Gender</label>
          <select class="form-control" name="gender" required>
            <option selected disabled value="">Select Gender</option>
            <option value="Female">Female</option>
            <option value="Male">Male</option>
          </select>
        </div>

        <!-- 3) age (use bracket bins exactly as in training) -->
        <div class="mb-3">
          <label class="form-label">Age Range</label>
          <select class="form-control" name="age" required>
            <option selected disabled value="">Select Age</option>
            <option value="[0-10)">[0-10)</option>
            <option value="[10-20)">[10-20)</option>
            <option value="[20-30)">[20-30)</option>
            <option value="[30-40)">[30-40)</option>
            <option value="[40-50)">[40-50)</option>
            <option value="[50-60)">[50-60)</option>
            <option value="[60-70)">[60-70)</option>
            <option value="[70-80)">[70-80)</option>
            <option value="[80-90)">[80-90)</option>
            <option value="[90-100)">[90-100)</option>
          </select>
        </div>

        <!-- 4) time_in_hospital (simple bounded integer) -->
        <div class="mb-3">
          <label class="form-label">Time in Hospital (days)</label>
          <input type="number" class="form-control" name="time_in_hospital"
                 id="time_in_hospital" placeholder="1–14" min="1" max="14" required>
        </div>

        <!-- 5) num_lab_procedures (1–132 with holes forbidden) -->
        <div class="mb-3">
          <label class="form-label">Number of Lab Procedures (allowed 1–132)</label>
          <input type="number" class="form-control" name="num_lab_procedures"
                 id="num_lab_procedures" placeholder="1–132" min="1" max="132" required>
          <div class="form-text">Some values within 1–132 are disallowed and will be rejected.</div>
        </div>

        <!-- 6) num_procedures (0–6) -->
        <div class="mb-3">
          <label class="form-label">Number of Other Procedures (0–6)</label>
          <input type="number" class="form-control" name="num_procedures"
                 id="num_procedures" placeholder="0–6" min="0" max="6" required>
        </div>

        <!-- 7) num_medications (1–81 with holes forbidden) -->
        <div class="mb-3">
          <label class="form-label">Number of Medications (allowed 1–81)</label>
          <input type="number" class="form-control" name="num_medications"
                 id="num_medications" placeholder="1–81" min="1" max="81" required>
          <div class="form-text">Some values within 1–81 are disallowed and will be rejected.</div>
        </div>

        <!-- 8) number_outpatient (0–42 with holes forbidden) -->
        <div class="mb-3">
          <label class="form-label">Number of Outpatient Visits (allowed 0–42)</label>
          <input type="number" class="form-control" name="number_outpatient"
                 id="number_outpatient" placeholder="0–42" min="0" max="42" required>
          <div class="form-text">Some values within 0–42 are disallowed and will be rejected.</div>
        </div>

        <!-- 9) number_emergency (allow-list) -->
        <div class="mb-3">
          <label class="form-label">Number of Emergency Visits (allowed list)</label>
          <input type="number" class="form-control" name="number_emergency"
                 id="number_emergency" placeholder="Allowed values only" required>
          <div class="form-text">Only specific values are allowed (validated below).</div>
        </div>

        <!-- 10) number_inpatient (allow-list) -->
        <div class="mb-3">
          <label class="form-label">Number of Inpatient Visits (allowed list)</label>
          <input type="number" class="form-control" name="number_inpatient"
                 id="number_inpatient" placeholder="Allowed values only" required>
        </div>

        <!-- 11) number_diagnoses (allow-list) -->
        <div class="mb-3">
          <label class="form-label">Number of Diagnoses (allowed list)</label>
          <input type="number" class="form-control" name="number_diagnoses"
                 id="number_diagnoses" placeholder="Allowed values only" required>
        </div>

        <!-- 12) metformin -->
        <div class="mb-3">
          <label class="form-label">Metformin</label>
          <select class="form-control" name="metformin" required>
            <option selected disabled value="">Select</option>
            <option value="No">No</option>
            <option value="Steady">Steady</option>
            <option value="Up">Up</option>
            <option value="Down">Down</option>
          </select>
        </div>

        <!-- 13) change -->
        <div class="mb-3">
          <label class="form-label">Change in Medications</label>
          <select class="form-control" name="change" required>
            <option selected disabled value="">Select</option>
            <option value="No">No</option>
            <option value="Ch">Ch</option>
          </select>
        </div>

        <!-- 14) diabetesMed -->
        <div class="mb-3">
          <label class="form-label">On Diabetes Medication</label>
          <select class="form-control" name="diabetesMed" required>
            <option selected disabled value="">Select</option>
            <option value="No">No</option>
            <option value="Yes">Yes</option>
          </select>
        </div>

        <!-- 15) medical_specialty (5 options + Unknown/Other) -->
        <div class="mb-3">
          <label class="form-label">Medical Specialty</label>
          <select class="form-control" name="medical_specialty" required>
            <option selected disabled value="">Select Specialty</option>
            <option value="InternalMedicine">InternalMedicine</option>
            <option value="Emergency/Trauma">Emergency/Trauma</option>
            <option value="Family/GeneralPractice">Family/GeneralPractice</option>
            <option value="Cardiology">Cardiology</option>
            <option value="Surgery-General">Surgery-General</option>
            <option value="Unknown">Unknown</option>
            <option value="Other">Other</option>
          </select>
          <div class="form-text">High-cardinality field trimmed to popular options.</div>
        </div>

        <!-- 16) diag_1 (top 5 + Other) -->
        <div class="mb-3">
          <label class="form-label">Primary Diagnosis (diag_1)</label>
          <select class="form-control" name="diag_1" required>
            <option selected disabled value="">Select Primary Diagnosis</option>
            <option value="428">428</option>
            <option value="414">414</option>
            <option value="276">276</option>
            <option value="410">410</option>
            <option value="486">486</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <!-- 17) diag_2 (top 5 + Other) -->
        <div class="mb-3">
          <label class="form-label">Secondary Diagnosis (diag_2)</label>
          <select class="form-control" name="diag_2" required>
            <option selected disabled value="">Select Secondary Diagnosis</option>
            <option value="276">276</option>
            <option value="428">428</option>
            <option value="250.01">250.01</option>
            <option value="427">427</option>
            <option value="401">401</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <!-- 18) diag_3 (top 5 + Other) -->
        <div class="mb-3">
          <label class="form-label">Tertiary Diagnosis (diag_3)</label>
          <select class="form-control" name="diag_3" required>
            <option selected disabled value="">Select Tertiary Diagnosis</option>
            <option value="250">250</option>
            <option value="401">401</option>
            <option value="276">276</option>
            <option value="428">428</option>
            <option value="427">427</option>
            <option value="255">255</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <!-- 19) discharge_disposition_id (select allow-list) -->
        <div class="mb-3">
          <label class="form-label">Discharge Disposition ID</label>
          <select class="form-control" name="discharge_disposition_id" required>
            <option selected disabled value="">Select</option>
            <option>25</option><option>1</option><option>3</option><option>6</option><option>2</option>
            <option>5</option><option>11</option><option>7</option><option>10</option><option>4</option>
            <option>14</option><option>18</option><option>8</option><option>13</option><option>12</option>
            <option>16</option><option>17</option><option>22</option><option>23</option><option>9</option>
            <option>20</option><option>15</option><option>24</option><option>28</option><option>19</option>
            <option>27</option>
          </select>
        </div>

        <!-- 20) admission_source_id (select allow-list) -->
        <div class="mb-3">
          <label class="form-label">Admission Source ID</label>
          <select class="form-control" name="admission_source_id" required>
            <option selected disabled value="">Select</option>
            <option>1</option><option>7</option><option>2</option><option>4</option><option>5</option>
            <option>6</option><option>20</option><option>3</option><option>17</option><option>8</option>
            <option>9</option><option>14</option><option>10</option><option>22</option><option>11</option>
            <option>25</option><option>13</option>
          </select>
        </div>

        <!-- 21) admission_type_id (select allow-list) -->
        <div class="mb-3">
          <label class="form-label">Admission Type ID</label>
          <select class="form-control" name="admission_type_id" required>
            <option selected disabled value="">Select</option>
            <option>1</option><option>2</option><option>3</option><option>4</option><option>7</option>
          </select>
        </div>
      </div>

      <div class="mt-3">
        <button class="btn btn-primary" type="submit">Predict Readmission</button>
      </div>
    </form>

    {% if results is defined %}
      <hr/>
      <h3>Prediction: {{ results }}</h3>
    {% endif %}
  </div>

  <!-- Client-side validation for allowed/forbidden numeric values -->
  <script>
    // Forbidden sets inside otherwise-bounded ranges
    const forbidden_lab_procs = new Set([109,110,112,115,116,117,119,122,123,124,125,127,128,130]);
    const forbidden_num_meds  = new Set([71,73,76,77,78,80]);
    const forbidden_outpat    = new Set([30,31,32,41]);

    // Allowed sets for strict allow-list fields
    const allowed_emergency = new Set([0,1,2,4,3,9,5,7,6,8,22,25,10,13,42,16,11,28,15,14,18,12,21,20,19,46,76,37,64,63,54,24,29]);
    const allowed_inpatient = new Set([0,1,2,3,6,5,4,7,8,9,15,10,11,14,12,13,17,16,21,18,19]);
    const allowed_dx_count  = new Set([1,9,6,7,5,8,3,4,2,16,12,13,15,10,11,14]);

    function forbidSetCheck(inputEl, forbiddenSet) {
      const v = parseInt(inputEl.value);
      if (Number.isNaN(v)) { inputEl.setCustomValidity(""); return; }
      if (forbiddenSet.has(v)) {
        inputEl.setCustomValidity("This number is not allowed.");
      } else {
        inputEl.setCustomValidity("");
      }
    }
    function allowSetCheck(inputEl, allowedSet) {
      const v = parseInt(inputEl.value);
      if (Number.isNaN(v)) { inputEl.setCustomValidity(""); return; }
      if (!allowedSet.has(v)) {
        inputEl.setCustomValidity("Please enter an allowed value.");
      } else {
        inputEl.setCustomValidity("");
      }
    }

    // Hook up inputs
    document.getElementById("num_lab_procedures").addEventListener("input", function(){
      forbidSetCheck(this, forbidden_lab_procs);
    });
    document.getElementById("num_medications").addEventListener("input", function(){
      forbidSetCheck(this, forbidden_num_meds);
    });
    document.getElementById("number_outpatient").addEventListener("input", function(){
      forbidSetCheck(this, forbidden_outpat);
    });
    document.getElementById("number_emergency").addEventListener("input", function(){
      allowSetCheck(this, allowed_emergency);
    });
    document.getElementById("number_inpatient").addEventListener("input", function(){
      allowSetCheck(this, allowed_inpatient);
    });
    document.getElementById("number_diagnoses").addEventListener("input", function(){
      allowSetCheck(this, allowed_dx_count);
    });
  </script>
</body>
</html>
